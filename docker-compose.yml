version: '3.8'

services:
  icecap-sim:
    build: .
    image: icecap-sim:latest
    container_name: icecap-experiments
    volumes:
      # Mount directories for experiment outputs
      - ./experiments:/app/experiments
      - ./plots:/app/plots
      - ./experiment_logs:/app/experiment_logs
      # Optionally mount custom experiment configs
      - ./experiment_configs:/app/experiment_configs:ro
    environment:
      - PYTHONUNBUFFERED=1
      - DOCKER_CONTAINER=1
      # Pass experiment suite selection (default: all experiments)
      - EXP_ARGS=${EXP_ARGS:---seeds 3}
    # Default: run all experiments (Phase 2 & 3)
    # Override with: EXP_ARGS="--exp2.1 --exp2.2" docker-compose up
    # Or: docker-compose run icecap-sim scripts/run_baseline_experiments.sh --exp3.1 --quick
    command: >
      bash -c "
      echo 'Starting experiments...' &&
      echo 'Arguments: $${EXP_ARGS}' &&
      scripts/run_baseline_experiments.sh $${EXP_ARGS} 2>&1 | tee experiment_logs/run_$$(date +%Y%m%d_%H%M%S).log &&
      echo 'Experiments complete! Results in ./experiments/'
      "

  # Service for running analysis only (after experiments are done)
  analyze:
    build: .
    image: icecap-sim:latest
    container_name: icecap-analysis
    volumes:
      - ./experiments:/app/experiments:ro
      - ./plots:/app/plots
    command: >
      bash -c "
      echo 'Running saturation analysis...' &&
      python -m icecap.saturation_analysis -i experiments -o plots/exp2_1_analysis -p 'exp2_1_*' &&
      python -m icecap.saturation_analysis -i experiments -o plots/exp2_2_analysis -p 'exp2_2_*' --group-by num_tables &&
      echo 'Running distribution analysis...' &&
      python scripts/plot_distributions.py -i experiments -o plots/distributions -p 'exp2_*' &&
      echo 'Analysis complete! Results in ./plots/'
      "
    profiles:
      - analysis

  # Service for running conformance tests
  test:
    build: .
    image: icecap-sim:latest
    container_name: icecap-tests
    volumes:
      - ./experiments:/app/experiments:ro
    command: pytest tests/test_distribution_conformance.py -v
    profiles:
      - test

  # Service for running a single experiment with custom config
  single-experiment:
    build: .
    image: icecap-sim:latest
    container_name: icecap-single-experiment
    volumes:
      - ./experiments:/app/experiments
      - ./experiment_configs:/app/experiment_configs:ro
    environment:
      - EXPERIMENT_CONFIG=${EXPERIMENT_CONFIG:-experiment_configs/exp2_1_single_table_false_conflicts.toml}
    command: >
      bash -c "
      echo 'Running experiment: $${EXPERIMENT_CONFIG}' &&
      echo 'Y' | python -m icecap.main $${EXPERIMENT_CONFIG} &&
      echo 'Experiment complete!'
      "
    profiles:
      - single

  # Service for running experiment batches (for missing experiments)
  batch:
    build: .
    image: icecap-sim:latest
    container_name: icecap-batch
    volumes:
      - ./experiment_batch:/app/experiment_batch
    environment:
      - PYTHONUNBUFFERED=1
      - DOCKER_CONTAINER=1
      - OMP_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - NUMEXPR_NUM_THREADS=1
      - BATCH_PARALLEL=${BATCH_PARALLEL:-4}
    command: >
      bash -c "
      if [ ! -d /app/experiment_batch ]; then
        echo 'Error: experiment_batch directory not found!';
        echo 'Run: ./scripts/prepare_missing_experiments.sh';
        exit 1;
      fi &&
      cd /app/experiment_batch &&
      echo 'Starting batch execution with parallelism: $${BATCH_PARALLEL}' &&
      ./run_experiments.sh --parallel $${BATCH_PARALLEL} &&
      echo 'Batch complete! Results in experiment_batch/results/'
      "
    profiles:
      - batch
