version: '3.8'

services:
  icecap-sim:
    build: .
    image: icecap-sim:latest
    container_name: icecap-experiments
    volumes:
      # Mount directories for experiment outputs
      - ./experiments:/app/experiments
      - ./plots:/app/plots
      - ./experiment_logs:/app/experiment_logs
      # Optionally mount custom experiment configs
      - ./experiment_configs:/app/experiment_configs:ro
    environment:
      - PYTHONUNBUFFERED=1
    # Default: run baseline experiments
    # Override with: docker-compose run icecap-sim <custom-command>
    command: >
      bash -c "
      echo 'Starting baseline experiments...' &&
      scripts/run_baseline_experiments.sh 2>&1 | tee experiment_logs/run_$$(date +%Y%m%d_%H%M%S).log &&
      echo 'Experiments complete! Results in ./experiments/'
      "

  # Service for running analysis only (after experiments are done)
  analyze:
    build: .
    image: icecap-sim:latest
    container_name: icecap-analysis
    volumes:
      - ./experiments:/app/experiments:ro
      - ./plots:/app/plots
    command: >
      bash -c "
      echo 'Running saturation analysis...' &&
      python -m icecap.saturation_analysis -i experiments -o plots/exp2_1_analysis -p 'exp2_1_*' &&
      python -m icecap.saturation_analysis -i experiments -o plots/exp2_2_analysis -p 'exp2_2_*' --group-by num_tables &&
      echo 'Running distribution analysis...' &&
      python scripts/plot_distributions.py -i experiments -o plots/distributions -p 'exp2_*' &&
      echo 'Analysis complete! Results in ./plots/'
      "
    profiles:
      - analysis

  # Service for running conformance tests
  test:
    build: .
    image: icecap-sim:latest
    container_name: icecap-tests
    volumes:
      - ./experiments:/app/experiments:ro
    command: pytest tests/test_distribution_conformance.py -v
    profiles:
      - test

  # Service for running a single experiment with custom config
  single-experiment:
    build: .
    image: icecap-sim:latest
    container_name: icecap-single-experiment
    volumes:
      - ./experiments:/app/experiments
      - ./experiment_configs:/app/experiment_configs:ro
    environment:
      - EXPERIMENT_CONFIG=${EXPERIMENT_CONFIG:-experiment_configs/exp2_1_single_table_false_conflicts.toml}
    command: >
      bash -c "
      echo 'Running experiment: $${EXPERIMENT_CONFIG}' &&
      echo 'Y' | python -m icecap.main $${EXPERIMENT_CONFIG} &&
      echo 'Experiment complete!'
      "
    profiles:
      - single
